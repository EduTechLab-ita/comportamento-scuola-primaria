<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PWA - Comportamento Scuola</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 15px 0; border-radius: 8px; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .info { color: #2196f3; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #1e88e5; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1565c0; }
        #test-results { margin-top: 20px; }
        .icon-test { display: flex; gap: 10px; align-items: center; margin: 5px 0; }
        .icon-test img { width: 32px; height: 32px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üß™ Test PWA - Comportamento Scuola</h1>
    <p>Questa pagina testa tutte le funzionalit√† PWA dell'app COMPORTAMENTO-SCUOLA</p>

    <div class="test-section">
        <h2>üìã Test Manifest.json</h2>
        <div id="manifest-status">Caricamento...</div>
        <button onclick="testManifest()">üîç Testa Manifest</button>
    </div>

    <div class="test-section">
        <h2>üé® Test Icone PWA</h2>
        <div id="icons-status">Caricamento...</div>
        <div id="icons-display"></div>
        <button onclick="testIcons()">üñºÔ∏è Testa Icone</button>
    </div>

    <div class="test-section">
        <h2>‚öôÔ∏è Test Service Worker</h2>
        <div id="sw-status">Caricamento...</div>
        <button onclick="testServiceWorker()">üîß Testa Service Worker</button>
    </div>

    <div class="test-section">
        <h2>üì± Test Installabilit√†</h2>
        <div id="install-status">Caricamento...</div>
        <button onclick="testInstallability()">üì≤ Testa Installazione</button>
    </div>

    <div class="test-section">
        <h2>üîó Link Diretti</h2>
        <p><a href="index.html" target="_blank">üìù Apri App Principale</a></p>
        <p><a href="manifest.json" target="_blank">üìÑ Visualizza Manifest</a></p>
        <p><a href="sw.js" target="_blank">‚öôÔ∏è Visualizza Service Worker</a></p>
        <p><a href="icons/" target="_blank">üé® Cartella Icone</a></p>
    </div>

    <div id="test-results"></div>

    <script>
        let testResults = [];

        function addResult(test, status, message, type = 'info') {
            testResults.push({test, status, message, type});
            updateResults();
        }

        function updateResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h2>üìä Risultati Test</h2>' + 
                testResults.map(r => 
                    `<div class="${r.type}">
                        ${r.status ? '‚úÖ' : '‚ùå'} ${r.test}: ${r.message}
                    </div>`
                ).join('');
        }

        async function testManifest() {
            document.getElementById('manifest-status').innerHTML = 'Testing...';
            try {
                const response = await fetch('manifest.json');
                const manifest = await response.json();
                
                // Test campi obbligatori
                const required = ['name', 'short_name', 'start_url', 'display', 'icons'];
                const missing = required.filter(field => !manifest[field]);
                
                if (missing.length === 0) {
                    document.getElementById('manifest-status').innerHTML = 
                        '<span class="success">‚úÖ Manifest valido</span><br>' +
                        `Nome: ${manifest.name}<br>` +
                        `Nome breve: ${manifest.short_name}<br>` +
                        `Icone: ${manifest.icons.length} definite<br>` +
                        `Display: ${manifest.display}`;
                    addResult('Manifest.json', true, 'Tutti i campi obbligatori presenti', 'success');
                } else {
                    document.getElementById('manifest-status').innerHTML = 
                        '<span class="error">‚ùå Campi mancanti: ' + missing.join(', ') + '</span>';
                    addResult('Manifest.json', false, 'Campi mancanti: ' + missing.join(', '), 'error');
                }
            } catch (error) {
                document.getElementById('manifest-status').innerHTML = 
                    '<span class="error">‚ùå Errore caricamento manifest: ' + error.message + '</span>';
                addResult('Manifest.json', false, 'Errore: ' + error.message, 'error');
            }
        }

        async function testIcons() {
            document.getElementById('icons-status').innerHTML = 'Testing...';
            const iconsDisplay = document.getElementById('icons-display');
            iconsDisplay.innerHTML = '';
            
            const iconSizes = [72, 96, 128, 144, 152, 192, 384, 512];
            let loadedIcons = 0;
            let totalIcons = iconSizes.length;

            for (const size of iconSizes) {
                const iconPath = `icons/icon-${size}x${size}.png`;
                const img = new Image();
                
                img.onload = function() {
                    loadedIcons++;
                    const iconTest = document.createElement('div');
                    iconTest.className = 'icon-test';
                    iconTest.innerHTML = 
                        `<img src="${iconPath}" alt="Icon ${size}x${size}">
                         <span class="success">‚úÖ ${size}x${size} - Caricata (${this.width}x${this.height})</span>`;
                    iconsDisplay.appendChild(iconTest);
                    
                    if (loadedIcons === totalIcons) {
                        document.getElementById('icons-status').innerHTML = 
                            `<span class="success">‚úÖ Tutte le ${totalIcons} icone caricate correttamente</span>`;
                        addResult('Icone PWA', true, `${totalIcons}/${totalIcons} icone caricate`, 'success');
                    }
                };

                img.onerror = function() {
                    const iconTest = document.createElement('div');
                    iconTest.className = 'icon-test';
                    iconTest.innerHTML = `<span class="error">‚ùå ${size}x${size} - Errore caricamento</span>`;
                    iconsDisplay.appendChild(iconTest);
                    addResult(`Icona ${size}x${size}`, false, 'Errore caricamento', 'error');
                };

                img.src = iconPath;
            }
        }

        async function testServiceWorker() {
            document.getElementById('sw-status').innerHTML = 'Testing...';
            
            if ('serviceWorker' in navigator) {
                try {
                    // Test registrazione
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    document.getElementById('sw-status').innerHTML = 
                        '<span class="success">‚úÖ Service Worker supportato e registrato</span><br>' +
                        `Scope: ${registration.scope}<br>` +
                        `Stato: ${registration.active ? 'Attivo' : 'In attivazione'}`;
                    addResult('Service Worker', true, 'Registrato e funzionante', 'success');
                } catch (error) {
                    document.getElementById('sw-status').innerHTML = 
                        '<span class="error">‚ùå Errore registrazione: ' + error.message + '</span>';
                    addResult('Service Worker', false, 'Errore registrazione: ' + error.message, 'error');
                }
            } else {
                document.getElementById('sw-status').innerHTML = 
                    '<span class="error">‚ùå Service Worker non supportato dal browser</span>';
                addResult('Service Worker', false, 'Non supportato dal browser', 'error');
            }
        }

        function testInstallability() {
            document.getElementById('install-status').innerHTML = 'Testing...';
            
            // Test supporto PWA
            const isPWASupported = 'serviceWorker' in navigator && 'PushManager' in window;
            
            if (isPWASupported) {
                document.getElementById('install-status').innerHTML = 
                    '<span class="success">‚úÖ PWA supportata dal browser</span><br>' +
                    'Per testare l\'installazione:<br>' +
                    '1. Apri <a href="index.html" target="_blank">l\'app principale</a><br>' +
                    '2. In Chrome: cerca l\'icona "Installa" nella barra indirizzi<br>' +
                    '3. Su mobile: Menu ‚Üí "Aggiungi alla schermata home"';
                addResult('Installabilit√† PWA', true, 'Browser supporta PWA', 'success');
            } else {
                document.getElementById('install-status').innerHTML = 
                    '<span class="warning">‚ö†Ô∏è Alcune funzioni PWA potrebbero non essere supportate</span>';
                addResult('Installabilit√† PWA', false, 'Supporto PWA limitato', 'warning');
            }

            // Test HTTPS (richiesto per PWA)
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            if (isHTTPS) {
                addResult('HTTPS/Localhost', true, 'Protocollo sicuro', 'success');
            } else {
                addResult('HTTPS/Localhost', false, 'PWA richiede HTTPS o localhost', 'warning');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', function() {
            setTimeout(() => {
                testManifest();
                testIcons();
                testServiceWorker();
                testInstallability();
            }, 1000);
        });
    </script>
</body>
</html>